<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Livret scolaire</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <h1>Livret scolaire</h1>
        <div class="header-buttons">
            <button id="generateWordButton" onclick="generateAllWordsInSection()" title="Générer les livrets Word pour tous les élèves">Générer Tous les Livrets (Word)</button>
            <button id="generateExcelButton" onclick="generateExcel()" style="background-color: #198754;" title="Générer un export Excel">Générer Excel (Section)</button>
        </div>
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar">
                <span class="progress-text" id="progressText">0%</span>
            </div>
        </div>
    </header>

    <main>
        <div class="select-container">
            <section id="step1">
                <h2>1. Choisir une Classe</h2>
                <select id="classSelector" onchange="handleClassChange(this.value)">
                    <option value="">-- Sélectionnez une Classe --</option>
                    <option value="PEI1">PEI1</option>
                    <option value="PEI2">PEI2</option>
                    <option value="PEI3">PEI3</option>
                    <option value="PEI4">PEI4</option>
                    <option value="DP2">DP2</option>
                </select>
            </section>
            
            <section id="step3" style="display: none;">
                <h2>2. Choisir un Élève</h2>
                <select id="studentSelector" onchange="handleStudentChange(this.value)">
                    <option value="">-- Sélectionnez un élève --</option>
                </select>
            </section>
        </div>

        <div id="studentInfoContainer" class="data-container" style="display: none">
            <h2>Informations Élève</h2>
            <div class="student-info">
                <div class="student-photo-birthdate-container">
                    <img id="studentPhotoPreview" style="display: none;" src="#" alt="Photo de l'élève">
                    <div class="birthdate-container">
                        <label for="studentBirthdate">Date de naissance:</label>
                        <input type="date" id="studentBirthdate" onchange="handleStudentBirthdateChange(this.value)" title="Date de naissance">
                    </div>
                </div>
                <div>
                    <label for="studentNameDisplay">Nom:</label>
                    <p id="studentNameDisplay"></p>
                </div>
                <div class="student-info-buttons">
                    <button onclick="showStudentData();" title="Voir toutes les contributions">Afficher Contributions</button>
                </div>
            </div>
            
            <section id="step2" style="display: none; margin-top: 20px; padding: 15px;">
                <h2>3. Choisir une Matière</h2>
                <select id="subjectSelector" onchange="handleSubjectChange(this.value)">
                    <option value="">-- Sélectionnez une matière --</option>
                </select>
            </section>
        </div>

        <div id="contributionEntrySections" style="display: none;">
            <section id="communicationTable">
                <h2>Critères Initiaux (Compétences Approche de l'Apprentissage)</h2>
                <p style="font-size: 0.9em; color: #6c757d;">
                    <span style="font-weight: bold;">E</span>: Excellent | 
                    <span style="font-weight: bold;">A</span>: Acquis | 
                    <span style="font-weight: bold;">PA</span>: Partiellement Acquis | 
                    <span style="font-weight: bold;">I</span>: Insuffisant
                </p>
                <table>
                    <thead>
                        <tr>
                            <th></th>
                            <th>Communication</th>
                            <th>Collaboration</th>
                            <th>Autogestion</th>
                            <th>Recherche</th>
                            <th>Réflexion</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th>Évaluation</th>
                            <td><select onchange="handleCommunicationChange()"><option value=""></option><option>E</option><option>A</option><option>PA</option><option>I</option></select></td>
                            <td><select onchange="handleCommunicationChange()"><option value=""></option><option>E</option><option>A</option><option>PA</option><option>I</option></select></td>
                            <td><select onchange="handleCommunicationChange()"><option value=""></option><option>E</option><option>A</option><option>PA</option><option>I</option></select></td>
                            <td><select onchange="handleCommunicationChange()"><option value=""></option><option>E</option><option>A</option><option>PA</option><option>I</option></select></td>
                            <td><select onchange="handleCommunicationChange()"><option value=""></option><option>E</option><option>A</option><option>PA</option><option>I</option></select></td>
                        </tr>
                    </tbody>
                </table>
            </section>
            
            <section id="criteriaTable">
                <h2>Critères d'Évaluation (Matière)</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Critères</th>
                            <th>Semestre 1 (/8)</th>
                            <th>Semestre 2 (/8)</th>
                            <th>Niveau Final (/8)</th>
                            <th>Seuil Total (/32)</th>
                            <th>Note Finale (/8)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>A</td>
                            <td><input type="number" min="0" max="8" oninput="validateInput(this)"></td>
                            <td><input type="number" min="0" max="8" oninput="validateInput(this)"></td>
                            <td><input type="number" readonly tabindex="-1"></td>
                            <td rowspan="4"><input id="threshold" type="number" readonly tabindex="-1" style="background-color: #e9ecef;"></td>
                            <td rowspan="4"><input id="finalNote" type="number" readonly tabindex="-1" style="background-color: #e9ecef;"></td>
                        </tr>
                        <tr>
                            <td>B</td>
                            <td><input type="number" min="0" max="8" oninput="validateInput(this)"></td>
                            <td><input type="number" min="0" max="8" oninput="validateInput(this)"></td>
                            <td><input type="number" readonly tabindex="-1"></td>
                        </tr>
                        <tr>
                            <td>C</td>
                            <td><input type="number" min="0" max="8" oninput="validateInput(this)"></td>
                            <td><input type="number" min="0" max="8" oninput="validateInput(this)"></td>
                            <td><input type="number" readonly tabindex="-1"></td>
                        </tr>
                        <tr>
                            <td>D</td>
                            <td><input type="number" min="0" max="8" oninput="validateInput(this)"></td>
                            <td><input type="number" min="0" max="8" oninput="validateInput(this)"></td>
                            <td><input type="number" readonly tabindex="-1"></td>
                        </tr>
                    </tbody>
                </table>
                <h3>Commentaires</h3>
                <textarea id="teacherComment" rows="4" placeholder="Écrivez vos commentaires ici..." onchange="handleCommentChange(this.value)"></textarea>
                <h3>Nom de l'enseignant</h3>
                <input id="teacherName" placeholder="Entrez votre nom" onchange="handleTeacherNameChange(this.value)">
                <div style="text-align: right; margin-top: 20px;">
                    <button id="submitButton" onclick="submitForm()">Soumettre / Mettre à jour</button>
                </div>
            </section>
        </div>

        <div class="data-container" id="dataContainer"></div>
    </main>

    <script>
        // Variables globales
        let currentData = {
            contributionId: null,
            teacherName: localStorage.getItem('teacherName') || null,
            classSelected: null,
            sectionSelected: 'garçons', // Auto-sélectionné
            subjectSelected: null,
            studentSelected: null,
            studentBirthdate: null,
            studentPhoto: null,
            teacherComment: null,
            communicationEvaluation: ['', '', '', '', ''],
            criteriaValues: {
                A: {sem1: null, sem2: null, finalLevel: null},
                B: {sem1: null, sem2: null, finalLevel: null},
                C: {sem1: null, sem2: null, finalLevel: null},
                D: {sem1: null, sem2: null, finalLevel: null}
            }
        };
        
        let currentContributionId = null;

        // Éléments DOM
        const progressBarContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const studentInfoContainer = document.getElementById('studentInfoContainer');
        const contributionEntrySections = document.getElementById('contributionEntrySections');
        const submitButton = document.getElementById('submitButton');
        const teacherNameInput = document.getElementById('teacherName');
        const classSelector = document.getElementById('classSelector');
        const studentSelector = document.getElementById('studentSelector');
        const subjectSelector = document.getElementById('subjectSelector');
        const dataContainer = document.getElementById('dataContainer');
        const studentBirthdateInput = document.getElementById('studentBirthdate');

        // Données des étudiants
        const studentData = {
            'Faysal': {birthdate: '2014-04-15', photo: 'https://lh3.googleusercontent.com/d/1IB6BKROX3TRxaIIHVVVWbB7-Ii-V8VrC'},
            'Bilal': {birthdate: '2015-02-15', photo: 'https://lh3.googleusercontent.com/d/1B0QUZJhpSad5Fs3qRTugUe4oyTlUDEVu'},
            'Jad': {birthdate: '2014-08-15', photo: 'https://lh3.googleusercontent.com/d/1VLvrWjeJwaClf4pSaLiwjnS79N-HrsFr'},
            'Manaf': {birthdate: '2014-08-15', photo: 'https://lh3.googleusercontent.com/d/1h46Tqtqcp5tNqdY62wV6pyZFYknCEMWY'},
            'Ahmed': {birthdate: '2013-09-15', photo: 'https://lh3.googleusercontent.com/d/1cDF-yegSB2tqsWac0AoNttbi8qAALYT1'},
            'Yasser': {birthdate: '2013-08-15', photo: 'https://lh3.googleusercontent.com/d/1UUrrAJV_bgFNktGDinDkSrpwSZz-e47T'},
            'Eyad': {birthdate: '2013-04-15', photo: 'https://lh3.googleusercontent.com/d/1HGyWS4cC1jWWD25Ah3WcT_eIbUHqFzJ1'},
            'Ali': {birthdate: '2013-04-15', photo: 'https://lh3.googleusercontent.com/d/1bN-fDf_IWkXoW3WjSOXI5_M4KkL3FDKr'},
            'Seifeddine': {birthdate: '2012-01-15', photo: 'https://lh3.googleusercontent.com/d/1tWdPSbtCAsTMB86WzDgqh3Xw01ahm9s6'},
            'Mohamed': {birthdate: '2011-11-15', photo: 'https://lh3.googleusercontent.com/d/1lB8ObGOvQDVT6FITL2y7C5TYmAGyggFn'},
            'Wajih': {birthdate: '2012-06-15', photo: 'https://lh3.googleusercontent.com/d/1MH6M05mQamOHevmDffVFNpSFNnxqbxs3'},
            'Ahmad': {birthdate: '2012-02-15', photo: 'https://lh3.googleusercontent.com/d/1zU-jBuAbYjHanzank9C1BAd00skS1Y5J'},
            'Adam': {birthdate: '2012-12-15', photo: 'https://lh3.googleusercontent.com/d/15I9p6VSnn1yVmPxRRbGsUkM-fsBKYOWF'},
            'Mohamed Younes': {birthdate: '2011-11-15', photo: 'https://lh3.googleusercontent.com/d/1wzraoZY_lRafcDXeaxSBeX5cIU57p4xA'},
            'Mohamed Amine': {birthdate: '2012-12-15', photo: 'https://lh3.googleusercontent.com/d/1UrBw6guz0oBTUy8COGeewIs3XAK773bR'},
            'Samir': {birthdate: '2012-12-15', photo: 'https://lh3.googleusercontent.com/d/1NdaCH8CU0DJFHXw4D0lItP-QnCswl23b'},
            'Abdulrahman': {birthdate: '2012-04-15', photo: 'https://lh3.googleusercontent.com/d/1yCTO5StU2tnPY0BEynnWzUveljMIUcLE'},
            'Youssef': {birthdate: '2011-11-15', photo: 'https://lh3.googleusercontent.com/d/1Bygg5-PYrjjMOZdI5hAe16eZ8ltn772e'},
            'Habib': {birthdate: '2008-10-15', photo: 'https://lh3.googleusercontent.com/d/13u4y6JIyCBVQ_9PCwYhh837byyK9g8pF'},
            'Salah': {birthdate: '2008-07-15', photo: 'https://lh3.googleusercontent.com/d/1IG8S_i6jD8O6C2QD_nwLxrG932QgIVXu'}
        };

        // Matières par classe
        const subjectsByClass = {
            PEI1: ["Éducation Physique", "Musique", "L.L", "I.S", "Sciences", "Mathématiques", "Design", "Langue Anglaise"],
            PEI2: ["Éducation Physique", "Musique", "ART", "L.L", "I.S", "Biologie", "Physique-Chimie", "Mathématiques", "Design", "Langue Anglaise"],
            PEI3: ["Éducation Physique", "Musique", "ART", "L.L", "I.S", "Biologie", "Physique-Chimie", "Mathématiques", "Design", "Langue Anglaise"],
            PEI4: ["Éducation Physique", "ART", "L.L", "I.S", "Biologie", "Physique-Chimie", "Mathématiques", "Design", "Langue Anglaise"],
            DP2: ["Éducation Physique", "ART", "L.L", "I.S", "Biologie", "Physique-Chimie", "Mathématiques", "E.S", "Langue Anglaise"]
        };

        // Critères par matière
        const criteriaBySubject = {
            "L.L": {A: "Analyse", B: "Organisation", C: "Production de texte", D: "Utilisation de la langue"},
            "Mathématiques": {A: "Connaissances et compréhension", B: "Recherche de modèles", C: "Communication", D: "Application des mathématiques"},
            "I.S": {A: "Connaissances et compréhension", B: "Recherche", C: "Communication", D: "Pensée critique"},
            "Sciences": {A: "Connaissances et compréhension", B: "Recherche et élaboration", C: "Traitement et évaluation", D: "Réflexion sur les répercussions"},
            "Biologie": {A: "Connaissances et compréhension", B: "Recherche et élaboration", C: "Traitement et évaluation", D: "Réflexion sur les répercussions"},
            "Physique-Chimie": {A: "Connaissances et compréhension", B: "Recherche et élaboration", C: "Traitement et évaluation", D: "Réflexion sur les répercussions"},
            "Langue Anglaise": {A: "Listening", B: "Reading", C: "Speaking", D: "Writing"},
            "Design": {A: "Recherche et analyse", B: "Développement des idées", C: "Création de la solution", D: "Évaluation"},
            "Musique": {A: "Connaissances et comprehensions", B: "Développement des competences", C: "Pensée créative", D: "Réaction"},
            "ART": {A: "Connaissances et comprehensions", B: "Développement des competences", C: "Pensée créative", D: "Réaction"},
            "Éducation Physique": {A: "Connaissances et compréhension", B: "Planification", C: "Application et exécution", D: "Réflexion et amélioration"},
            "E.S": {A: "Connaissances et compréhension", B: "Recherche et élaboration", C: "Traitement et évaluation", D: "Réflexion sur les répercussions"}
        };

        // Élèves par classe
        const studentsByClass = {
            PEI1: ["Bilal", "Faysal", "Jad", "Manaf"],
            PEI2: ["Ahmed", "Ali", "Eyad", "Yasser"],
            PEI3: ["Adam", "Ahmad", "Mohamed", "Seifeddine", "Wajih"],
            PEI4: ["Abdulrahman", "Mohamed Amine", "Mohamed Younes", "Samir", "Youssef"],
            DP2: ["Habib", "Salah"]
        };

        // Fonctions utilitaires
        async function apiCall(endpoint, data) {
            try {
                const response = await fetch(`/api/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`API call failed for ${endpoint}:`, error);
                throw error;
            }
        }

        // Handlers de mise à jour des données
        function handleTeacherNameChange(value) {
            currentData.teacherName = value.trim();
            localStorage.setItem('teacherName', currentData.teacherName);
        }

        function handleStudentBirthdateChange(value) {
            currentData.studentBirthdate = value;
        }

        function handleCommentChange(value) {
            currentData.teacherComment = value;
        }

        function handleCommunicationChange() {
            currentData.communicationEvaluation = Array.from(
                document.querySelectorAll("#communicationTable tbody select")
            ).map(sel => sel.value);
        }

        function handleCriteriaChange(inputElement) {
            const row = inputElement.closest('tr');
            if (!row) return;
            
            const criteriaType = row.cells[0].textContent.charAt(0);
            const sem1Input = row.cells[1]?.querySelector('input');
            const sem2Input = row.cells[2]?.querySelector('input');
            
            const sem1Value = sem1Input?.value !== '' ? parseFloat(sem1Input.value) : null;
            const sem2Value = sem2Input?.value !== '' ? parseFloat(sem2Input.value) : null;
            
            if (!currentData.criteriaValues[criteriaType]) {
                currentData.criteriaValues[criteriaType] = { sem1: null, sem2: null, finalLevel: null };
            }
            
            currentData.criteriaValues[criteriaType].sem1 = sem1Value;
            currentData.criteriaValues[criteriaType].sem2 = sem2Value;
            
            calculateRow(row);
        }

        // Logique de sélection
        function handleClassChange(value) {
            currentData.classSelected = value;
            resetOnClassChange();
            if (value) populateStudents();
        }

        function handleStudentChange(value) {
            currentData.studentSelected = value;
            resetOnStudentChange();
            if (value) {
                showStudentInfo();
                populateSubjects();
            }
        }

        function handleSubjectChange(value) {
            currentData.subjectSelected = value;
            resetOnSubjectChange();
            if (value) {
                contributionEntrySections.style.display = "block";
                dataContainer.style.display = "none";
                fetchData();
                updateCriteriaTableHeaders();
            }
        }

        // Affichage des informations élève
        async function showStudentInfo() {
            const studentSelected = currentData.studentSelected;
            const studentPhotoPreview = document.getElementById('studentPhotoPreview');

            if (studentSelected) {
                studentInfoContainer.style.display = "block";
                document.getElementById('studentNameDisplay').textContent = studentSelected;

                // Utiliser les données locales pour la photo et la date initiale
                const studentLocalData = studentData[studentSelected];
                let localPhotoUrl = studentLocalData?.photo || null;
                let localBirthdate = studentLocalData?.birthdate || '';

                currentData.studentPhoto = localPhotoUrl;
                currentData.studentBirthdate = localBirthdate;

                // Afficher la photo
                if (localPhotoUrl) {
                    studentPhotoPreview.src = localPhotoUrl;
                    studentPhotoPreview.style.display = 'block';
                    studentPhotoPreview.onerror = () => {
                        console.error(`Erreur chargement image: ${localPhotoUrl}`);
                        studentPhotoPreview.style.display = 'none';
                    };
                } else {
                    studentPhotoPreview.style.display = 'none';
                    studentPhotoPreview.src = '#';
                }

                studentBirthdateInput.value = localBirthdate;

                // Récupérer la date de naissance du serveur
                try {
                    const infoFromServer = await apiCall('fetchStudentInfo', { studentSelected });
                    if (infoFromServer && infoFromServer.studentBirthdate) {
                        studentBirthdateInput.value = infoFromServer.studentBirthdate;
                        currentData.studentBirthdate = infoFromServer.studentBirthdate;
                    }
                } catch (error) {
                    console.error('Erreur récupération infos élève:', error);
                }
            } else {
                studentInfoContainer.style.display = "none";
            }
        }

        // Population des listes déroulantes
        function populateStudents() {
            const classSelected = currentData.classSelected;
            studentSelector.innerHTML = "<option value=''>-- Sélectionnez un élève --</option>";
            
            if (classSelected && studentsByClass[classSelected]) {
                const studentList = studentsByClass[classSelected];
                studentList.sort((a, b) => a.localeCompare(b));
                
                studentList.forEach(student => {
                    const option = document.createElement("option");
                    option.value = student;
                    option.textContent = student;
                    studentSelector.appendChild(option);
                });
                
                document.getElementById("step3").style.display = "block";
            } else {
                document.getElementById("step3").style.display = "none";
            }
            
            studentSelector.value = currentData.studentSelected || "";
        }

        function populateSubjects() {
            const classSelected = currentData.classSelected;
            const studentSelected = currentData.studentSelected;
            subjectSelector.innerHTML = "<option value=''>-- Sélectionnez une matière --</option>";
            
            if (classSelected && studentSelected && subjectsByClass[classSelected]) {
                subjectsByClass[classSelected].forEach(subject => {
                    const option = document.createElement("option");
                    option.value = subject;
                    option.textContent = subject;
                    subjectSelector.appendChild(option);
                });
                
                document.getElementById("step2").style.display = "block";
            } else {
                document.getElementById("step2").style.display = "none";
            }
            
            subjectSelector.value = currentData.subjectSelected || "";
        }

        function updateCriteriaTableHeaders() {
            const subject = currentData.subjectSelected;
            const criteriaLabels = criteriaBySubject[subject] || {};
            const rows = document.querySelectorAll("#criteriaTable tbody tr");
            
            rows.forEach((row, index) => {
                const key = String.fromCharCode(65 + index);
                const labelCell = row.cells[0];
                if (labelCell) {
                    labelCell.textContent = `${key}: ${criteriaLabels[key] || 'Critère ' + key}`;
                }
            });
        }

        // Validation et calculs
        function validateInput(input) {
            input.value = input.value.replace(/[^0-8]/g, '');
            if (input.value !== '' && parseFloat(input.value) > 8) {
                alert("Le maximum est 8.");
                input.value = 8;
            }
            handleCriteriaChange(input);
        }

        function calculateRow(rowElement) {
            const criteriaType = rowElement.cells[0]?.textContent.charAt(0);
            const sem1Input = rowElement.cells[1]?.querySelector('input');
            const sem2Input = rowElement.cells[2]?.querySelector('input');
            const finalLevelInput = rowElement.cells[3]?.querySelector('input');
            
            if (!criteriaType || !sem1Input || !sem2Input || !finalLevelInput) return;
            
            const sem1Value = sem1Input.value !== '' ? parseFloat(sem1Input.value) : null;
            const sem2Value = sem2Input.value !== '' ? parseFloat(sem2Input.value) : null;
            
            let finalLevel = null;
            if (sem1Value !== null && sem2Value !== null) {
                finalLevel = Math.round((sem1Value + sem2Value) / 2);
            } else if (sem1Value !== null) {
                finalLevel = sem1Value;
            } else if (sem2Value !== null) {
                finalLevel = sem2Value;
            }
            
            finalLevelInput.value = (finalLevel !== null) ? finalLevel : '';
            
            if (currentData.criteriaValues[criteriaType]) {
                currentData.criteriaValues[criteriaType].finalLevel = finalLevel;
            }
            
            calculateTotals();
        }

        function calculateTotals() {
            const rows = document.querySelectorAll("#criteriaTable tbody tr");
            let totalLevel = 0;
            
            rows.forEach(row => {
                const finalLevelInput = row.cells[3]?.querySelector('input');
                if (finalLevelInput?.value !== '') {
                    totalLevel += parseFloat(finalLevelInput.value);
                }
            });
            
            document.getElementById("threshold").value = totalLevel;
            
            let finalNote = 0;
            if (totalLevel > 0) {
                finalNote = Math.round(totalLevel / 4);
                if (finalNote < 1) finalNote = 1;
                if (finalNote > 8) finalNote = 8;
            }
            
            document.getElementById("finalNote").value = finalNote;
        }

        // Récupération des données
        async function fetchData() {
            if (currentData.studentSelected && currentData.subjectSelected) {
                try {
                    const data = await apiCall('fetchData', {
                        studentSelected: currentData.studentSelected,
                        subjectSelected: currentData.subjectSelected
                    });
                    
                    resetInputTables();
                    
                    if (data && !data.noDataForSubject) {
                        fillFormWithData(data);
                        currentContributionId = data._id || null;
                    } else {
                        currentContributionId = null;
                        teacherNameInput.value = currentData.teacherName || '';
                        document.getElementById('teacherComment').value = '';
                        calculateTotals();
                    }
                    
                    contributionEntrySections.style.display = "block";
                } catch (error) {
                    console.error('Erreur récupération données:', error);
                    alert('Erreur lors de la récupération des données.');
                }
            }
        }

        function fillFormWithData(data) {
            teacherNameInput.value = data.teacherName || currentData.teacherName || '';
            currentData.teacherName = teacherNameInput.value;
            localStorage.setItem('teacherName', currentData.teacherName);
            
            document.getElementById('teacherComment').value = data.teacherComment || '';
            currentData.teacherComment = data.teacherComment;
            
            currentData.communicationEvaluation = data.communicationEvaluation || ['', '', '', '', ''];
            document.querySelectorAll("#communicationTable tbody select").forEach((s, i) => {
                s.value = currentData.communicationEvaluation[i] || '';
            });
            
            currentData.criteriaValues = data.criteriaValues ? JSON.parse(JSON.stringify(data.criteriaValues)) : {A:{},B:{},C:{},D:{}};
            document.querySelectorAll("#criteriaTable tbody tr").forEach((row, i) => {
                const key = String.fromCharCode(65 + i);
                const critData = currentData.criteriaValues[key];
                const sem1Input = row.cells[1]?.querySelector('input');
                const sem2Input = row.cells[2]?.querySelector('input');
                
                if (sem1Input) sem1Input.value = critData?.sem1 ?? '';
                if (sem2Input) sem2Input.value = critData?.sem2 ?? '';
                calculateRow(row);
            });
            
            currentData.studentBirthdate = data.studentBirthdate || currentData.studentBirthdate || '';
            studentBirthdateInput.value = currentData.studentBirthdate;
            
            calculateTotals();
        }

        // Soumission du formulaire
        async function submitForm() {
            if (!currentData.teacherName || !currentData.classSelected || !currentData.studentSelected || !currentData.subjectSelected) {
                alert("Veuillez remplir tous les champs requis.");
                return;
            }
            
            submitButton.disabled = true;
            submitButton.textContent = "Envoi en cours...";
            
            try {
                // Assurer que la date de naissance est à jour
                currentData.studentBirthdate = studentBirthdateInput.value || null;
                
                const contributionData = { ...currentData, contributionId: currentContributionId };
                
                const result = await apiCall('saveContribution', contributionData);
                
                if (result.success) {
                    alert(`Contribution enregistrée ! (ID: ${result.data})`);
                    currentContributionId = result.data;
                    
                    if (currentData.studentSelected) {
                        fetchStudentContributions(currentData.studentSelected);
                    }
                } else {
                    throw new Error(result.error || 'Erreur inconnue');
                }
            } catch (error) {
                console.error('Erreur soumission:', error);
                alert(`Erreur: ${error.message || 'Erreur lors de la sauvegarde'}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = "Soumettre / Mettre à jour";
            }
        }

        // Affichage des contributions
        async function showStudentData() {
            const studentSelected = currentData.studentSelected;
            if (studentSelected) {
                contributionEntrySections.style.display = "none";
                dataContainer.style.display = "block";
                await fetchStudentContributions(studentSelected);
            } else {
                alert("Veuillez sélectionner un élève !");
            }
        }

        async function fetchStudentContributions(student) {
            if (!student) return;
            
            try {
                const contributions = await apiCall('fetchStudentContributions', { student });
                
                dataContainer.innerHTML = '<h3>Contributions Enregistrées</h3>';
                
                if (contributions && contributions.length > 0) {
                    contributions.sort((a, b) => (a.subjectSelected || "").localeCompare(b.subjectSelected || ""));
                    contributions.forEach(c => {
                        dataContainer.appendChild(createContributionElement(c));
                    });
                } else {
                    dataContainer.innerHTML += '<p>Aucune contribution trouvée pour cet élève.</p>';
                }
                
                dataContainer.style.display = "block";
            } catch (error) {
                console.error('Erreur récupération contributions:', error);
                alert('Erreur lors de la récupération des contributions.');
            }
        }

        function createContributionElement(c) {
            const div = document.createElement('div');
            div.className = 'contribution';
            const color = getSubjectColor(c.subjectSelected);
            
            div.innerHTML = `
                <div class="contribution-header" style="background-color:${color};">
                    <h3>${c.subjectSelected || 'N/A'}</h3>
                    <div class="contribution-buttons">
                        <button onclick="toggleContributionDetails(this)" data-contribution-id="${c._id}" title="Afficher/Masquer Détails">Afficher</button>
                        <button onclick="editContribution('${c._id}')" title="Modifier">Modifier</button>
                        <button onclick="deleteContribution('${c._id}')" title="Supprimer">Supprimer</button>
                    </div>
                </div>
                <div class="contribution-content" id="content-${c._id}" style="display: none;">
                    Chargement...
                </div>
            `;
            
            return div;
        }

        async function toggleContributionDetails(button) {
            const id = button.getAttribute('data-contribution-id');
            const content = document.getElementById(`content-${id}`);
            if (!content) return;
            
            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
            button.textContent = isHidden ? 'Masquer' : 'Afficher';
            
            if (isHidden && content.innerHTML === 'Chargement...') {
                try {
                    const data = await apiCall('fetchContribution', { contributionId: id });
                    if (data) {
                        renderContributionDetails(content, data);
                    } else {
                        content.innerHTML = '<p>Erreur chargement des détails.</p>';
                    }
                } catch (error) {
                    console.error('Erreur chargement détails:', error);
                    content.innerHTML = '<p>Erreur chargement des détails.</p>';
                }
            }
        }

        function renderContributionDetails(element, data) {
            const commHTML = createCommunicationTableHTML(data.communicationEvaluation);
            const critHTML = createCriteriaTableHTML(data.criteriaValues, data.subjectSelected);
            
            element.innerHTML = `
                <p><strong>Enseignant:</strong> ${data.teacherName || '-'}</p>
                <h4>Compétences</h4>
                ${commHTML}
                <h4>Critères (${data.subjectSelected || 'N/A'})</h4>
                ${critHTML}
                <h4>Commentaires</h4>
                <p>${data.teacherComment || '-'}</p>
                <p><small>Dernière modification: ${new Date(data.timestamp || Date.now()).toLocaleString('fr-FR')}</small></p>
            `;
        }

        function createCommunicationTableHTML(evals = []) {
            return `
                <table class="details-table">
                    <thead>
                        <tr><th>Comm</th><th>Collab</th><th>Auto</th><th>Rech</th><th>Refl</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${evals[0]||'-'}</td>
                            <td>${evals[1]||'-'}</td>
                            <td>${evals[2]||'-'}</td>
                            <td>${evals[3]||'-'}</td>
                            <td>${evals[4]||'-'}</td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        function createCriteriaTableHTML(criteria = {}, subject) {
            const labels = criteriaBySubject[subject] || {};
            let total = 0;
            
            const rows = ['A','B','C','D'].map(k => {
                const c = criteria[k] || {};
                const final = c.finalLevel ?? '-';
                if (final !== '-' && !isNaN(final)) total += parseFloat(final);
                return `<tr><td>${labels[k]||`Crit. ${k}`}</td><td>${c.sem1 ?? '-'}</td><td>${c.sem2 ?? '-'}</td><td>${final}</td></tr>`;
            }).join('');
            
            let note = 0;
            if (total > 0) {
                note = Math.round(total/4);
                if (note < 1) note = 1;
                if (note > 8) note = 8;
            }
            
            return `
                <table class="details-table">
                    <thead>
                        <tr><th>Critère</th><th>S1</th><th>S2</th><th>Final</th></tr>
                    </thead>
                    <tbody>${rows}</tbody>
                    <tfoot>
                        <tr><td colspan="3">Seuil /32:</td><td><strong>${total}</strong></td></tr>
                        <tr><td colspan="3">Note /8:</td><td><strong>${note}</strong></td></tr>
                    </tfoot>
                </table>
            `;
        }

        // Édition et suppression
        async function editContribution(contributionId) {
            try {
                const dataFromServer = await apiCall('fetchContribution', { contributionId });
                
                if (dataFromServer) {
                    contributionEntrySections.style.display = "block";
                    dataContainer.style.display = "none";
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    
                    currentContributionId = contributionId;
                    
                    fillFormWithData(dataFromServer);
                    
                    // Forcer l'utilisation de la photo locale
                    const studentName = dataFromServer.studentSelected;
                    const localPhotoUrl = studentData[studentName]?.photo || null;
                    currentData.studentPhoto = localPhotoUrl;
                    
                    const photoPreview = document.getElementById('studentPhotoPreview');
                    if (localPhotoUrl) {
                        photoPreview.src = localPhotoUrl;
                        photoPreview.style.display = 'block';
                        photoPreview.onerror = () => {
                            console.error(`Erreur chargement image edit: ${localPhotoUrl}`);
                            photoPreview.style.display = 'none';
                        };
                    } else {
                        photoPreview.style.display = 'none';
                        photoPreview.src = '#';
                    }
                    
                    // Mettre à jour les sélecteurs
                    classSelector.value = dataFromServer.classSelected || '';
                    currentData.classSelected = dataFromServer.classSelected;
                    populateStudents();
                    
                    setTimeout(() => {
                        studentSelector.value = studentName || '';
                        currentData.studentSelected = studentName;
                        populateSubjects();
                        
                        setTimeout(() => {
                            subjectSelector.value = dataFromServer.subjectSelected || '';
                            currentData.subjectSelected = dataFromServer.subjectSelected;
                            updateCriteriaTableHeaders();
                        }, 50);
                    }, 50);
                } else {
                    alert("Erreur lors de la récupération des données de la contribution à modifier.");
                    resetOnSubjectChange();
                }
            } catch (error) {
                console.error('Erreur édition contribution:', error);
                alert("Erreur lors de la récupération des données de la contribution à modifier.");
            }
        }

        async function deleteContribution(contributionId) {
            if (confirm(`Êtes-vous sûr de vouloir supprimer la contribution ID: ${contributionId} ? Cette action est irréversible.`)) {
                try {
                    const result = await apiCall('deleteContribution', { contributionId });
                    
                    if (result.success) {
                        alert("Contribution supprimée !");
                        if (currentData.studentSelected) {
                            fetchStudentContributions(currentData.studentSelected);
                        }
                        if (currentContributionId === contributionId) {
                            resetOnSubjectChange();
                        }
                    } else {
                        throw new Error(result.error || 'Erreur suppression');
                    }
                } catch (error) {
                    console.error('Erreur suppression:', error);
                    alert(`Erreur Suppression: ${error.message || 'Inconnue'}`);
                }
            }
        }

        // Génération de documents
        async function generateAllWordsInSection() {
            const section = currentData.sectionSelected;
            const classe = currentData.classSelected;

            if (!section || !classe) {
                alert("Veuillez d'abord sélectionner une classe.");
                return;
            }

            const studentList = studentsByClass[classe] || [];
            if (studentList.length === 0) {
                alert(`Aucun élève trouvé pour la classe ${classe}.`);
                return;
            }

            const confirmGeneration = confirm(`Vous allez générer ${studentList.length} livret(s) Word individuellement pour la classe ${classe}.\nChaque livret déclenchera un téléchargement séparé.\nVoulez-vous continuer ?`);
            if (!confirmGeneration) {
                return;
            }

            progressBarContainer.style.display = 'block';
            progressText.textContent = `Préparation... (0/${studentList.length})`;
            progressBar.style.width = '0%';
            document.getElementById('generateWordButton').disabled = true;

            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < studentList.length; i++) {
                const studentName = studentList[i];
                const photoUrl = studentData[studentName]?.photo || null;

                const currentProgress = Math.round((i / studentList.length) * 100);
                progressText.textContent = `Génération: ${studentName} (${i + 1}/${studentList.length}) - ${currentProgress}%`;
                progressBar.style.width = currentProgress + '%';

                try {
                    const result = await apiCall('generateSingleWord', {
                        studentSelected: studentName,
                        classSelected: classe,
                        sectionSelected: section,
                        studentPhotoUrl: photoUrl
                    });

                    if (result.success) {
                        handleDownloadLink(result);
                        successCount++;
                    } else {
                        throw new Error(result.error || 'Erreur génération');
                    }
                } catch (error) {
                    console.error(`Erreur génération pour ${studentName}:`, error);
                    alert(`Erreur génération Word pour ${studentName}: ${error.message}`);
                    errorCount++;
                }

                const progressAfter = Math.round(((i + 1) / studentList.length) * 100);
                progressBar.style.width = progressAfter + '%';
                progressText.textContent = `Terminé: ${studentName} (${i + 1}/${studentList.length}) - ${progressAfter}%`;

                // Pause entre les générations
                if (i < studentList.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            progressBar.style.width = '100%';
            progressText.textContent = `Terminé ! (${successCount} succès, ${errorCount} erreurs)`;
            setTimeout(() => {
                progressBarContainer.style.display = 'none';
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
            }, 3000);
            document.getElementById('generateWordButton').disabled = false;

            console.log(`Génération terminée. Succès: ${successCount}, Erreurs: ${errorCount}`);
        }

        function handleDownloadLink(data) {
            if (!data || !data.filePath || !data.fileName) {
                console.error("Données de téléchargement invalides", data);
                return;
            }

            const link = document.createElement('a');
            link.href = data.filePath.startsWith('/') ? data.filePath : '/' + data.filePath;
            link.download = data.fileName;
            document.body.appendChild(link);

            try {
                link.click();
                console.log(`Téléchargement déclenché: ${data.fileName}`);
            } catch (e) {
                console.error("Erreur téléchargement:", e);
                alert(`Impossible de lancer le téléchargement pour ${data.fileName}.`);
            }

            setTimeout(() => {
                if (document.body.contains(link)) {
                    document.body.removeChild(link);
                }
            }, 100);
        }

        // Génération Excel (placeholder)
        function generateExcel() {
            alert("Fonctionnalité Excel en cours d'implémentation.");
        }

        // Fonctions de réinitialisation
        function resetOnClassChange() {
            studentSelector.innerHTML = "<option value=''>-- Sélectionnez un élève --</option>";
            document.getElementById('step3').style.display = "none";
            currentData.classSelected = classSelector.value;
            resetOnStudentChange();
        }

        function resetOnStudentChange() {
            subjectSelector.innerHTML = "<option value=''>-- Sélectionnez une matière --</option>";
            document.getElementById('step2').style.display = "none";
            studentInfoContainer.style.display = "none";
            currentData.studentSelected = studentSelector.value;
            resetOnSubjectChange();
            dataContainer.style.display = "none";
        }

        function resetOnSubjectChange() {
            contributionEntrySections.style.display = "none";
            currentData.subjectSelected = subjectSelector.value;
            resetFormData();
        }

        function resetFormData() {
            resetInputTables();
            currentData.teacherComment = null;
            currentData.communicationEvaluation = ['', '', '', '', ''];
            currentData.criteriaValues = {
                A: {sem1: null, sem2: null, finalLevel: null},
                B: {sem1: null, sem2: null, finalLevel: null},
                C: {sem1: null, sem2: null, finalLevel: null},
                D: {sem1: null, sem2: null, finalLevel: null}
            };
            currentContributionId = null;
        }

        function resetInputTables() {
            document.querySelectorAll("#communicationTable tbody select").forEach(s => s.value = '');
            document.querySelectorAll("#criteriaTable tbody input").forEach(i => {
                if (!i.readOnly) i.value = '';
            });
            document.getElementById("threshold").value = '';
            document.getElementById("finalNote").value = '';
            document.getElementById('teacherComment').value = '';
        }

        // Fonction utilitaire pour les couleurs
        function getSubjectColor(subject) {
            const colors = {
                "L.L": "#0d6efd",
                "Mathématiques": "#198754",
                "I.S": "#6f42c1",
                "Sciences": "#ffc107",
                "Biologie": "#0dcaf0",
                "Physique-Chimie": "#d63384",
                "Langue Anglaise": "#adb5bd",
                "Design": "#6610f2",
                "Musique": "#dc3545",
                "ART": "#dc3545",
                "Éducation Physique": "#000",
                "E.S": "#6c757d"
            };
            return colors[subject] || "#6c757d";
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            if (currentData.teacherName) {
                teacherNameInput.value = currentData.teacherName;
            }
            
            console.log("Application prête.");
            
            // Auto-sélection déjà faite via currentData.sectionSelected = 'garçons'
        });
    </script>
</body>
</html>